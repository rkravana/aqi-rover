<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="data:,">
<meta charset="UTF-8">
<title>AQI Rover Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">



<style>
@keyframes dangerPulse {
  0%   { box-shadow: 0 0 20px red; }
  50%  { box-shadow: 0 0 60px red; }
  100% { box-shadow: 0 0 20px red; }
}
.mode-active{
  background:#ff9800 !important;
  color:#000;
  box-shadow:0 0 15px rgba(255,152,0,0.9);
  transform: scale(1.05);
}

.arrow-btn{
  width:48px;
  height:48px;
  font-size:20px;
  margin:4px;
  border-radius:8px;
  border:none;
  background:#333;
  color:white;
  cursor:pointer;
  transition: all 0.15s ease;
}

.arrow-btn.active{
  background:#ff9800;
  box-shadow:0 0 12px rgba(255,152,0,0.9);
  transform: scale(1.08);
}


/* Arrow Buttons */
.arrow-btn{
  width:60px;
  height:60px;
  font-size:28px;
  margin:6px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  background:#444;
  color:white;
}
.arrow-btn:hover{
  background:#222;
}

/* Joystick */
#joystick{
  width:160px;
  height:160px;
  background:#ddd;
  border-radius:50%;
  margin:20px auto;
  position:relative;
  touch-action:none;
}
#stick{
  width:60px;
  height:60px;
  background:#333;
  border-radius:50%;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
}

.danger-pulse {
  animation: dangerPulse 1s infinite;
}

/* ===== ROVER STATUS COLORS ===== */
.status-idle{ background:#9e9e9e; }
.status-start{ background:#4caf50; box-shadow:0 0 25px #4caf50; }
.status-stop{ background:#bdbdbd; }
.status-auto{ background:#2196f3; box-shadow:0 0 25px #2196f3; }
.status-manual{ background:#ff9800; box-shadow:0 0 25px #ff9800; }
.status-emergency{
  background:#f44336;
  color:white;
  animation:pulseRed 1s infinite;
}

/* ===== ANIMATIONS ===== */
.emergency-active{
  animation: pulseRed 1s infinite;
}
@keyframes pulseRed{
  0%{box-shadow:0 0 5px red;}
  50%{box-shadow:0 0 30px red;}
  100%{box-shadow:0 0 5px red;}
}

/* ===== BASE ===== */
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f2f4f7; /* neutral default */
  transition: background 0.8s ease;
}
.card{
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.card:hover{
  transform: translateY(-6px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.25);
}

.glow-green{ box-shadow: 0 0 25px rgba(76,175,80,0.8); }
.glow-yellow{ box-shadow: 0 0 25px rgba(255,235,59,0.8); }
.glow-orange{ box-shadow: 0 0 25px rgba(255,152,0,0.8); }
.glow-red{ box-shadow: 0 0 30px rgba(244,67,54,0.9); }

/* ===== CONTAINER ===== */
.wrapper{
  width:1100px;
  margin:30px auto;
  background:#f7f7f7;
  padding:30px;
  border-radius:25px;
}

/* ===== HEALTH ===== */
.health-banner{
  background: linear-gradient(135deg, #4caf50, #81c784);
  padding: 28px;
  text-align: center;
  font-weight: 900;
  font-size: 26px;
  border-radius: 28px;
  margin-bottom: 20px;
  font-family: 'Press Start 2P', cursive;
  letter-spacing: 1px;
  transition: background 0.5s ease, box-shadow 0.5s ease;
  box-shadow: 0 0 25px rgba(76,175,80,0.6);
}

/* ===== TOP ===== */
.top-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-bottom:25px;
}
.info-box{
  background:#8feb8e;
  padding:15px;
  border-radius:15px;
  font-size:22px;
  font-weight:bold;
}
/* ===== CONTENT ===== */
.content{
  display:grid;
  grid-template-columns:70px auto;
  gap:30px;
  align-items:center;
}

/* ===== RISK ===== */
.risk-meter{
  height: 390px;
  width: 32px;
  background: #222;
  border-radius: 20px;
  position: relative;
  box-shadow: inset 0 0 10px #000;
}
.risk-fill{
  position:absolute;
  bottom:0;
  width:100%;
  height:0%;
  border-radius:20px;
  background:#4caf50;
  transition: height 0.8s cubic-bezier(.4,0,.2,1),
              background 0.4s ease,
              box-shadow 0.4s ease;
  box-shadow: 0 0 20px currentColor;
}
/* ===== MANUAL CONTROL LAYOUT ===== */
.manual-wrapper{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:80px;
  margin-top:30px;
}

/* D-PAD */
.dpad{
  display:flex;
  flex-direction:column;
  align-items:center;
}
.dpad div{
  display:flex;
  gap:10px;
}
.dpad button{
  width:48px;
  height:48px;
  font-size:20px;
  border:none;
  border-radius:8px;
  background:#3b3b3b;
  color:white;
  cursor:pointer;
}
.dpad button:hover{
  background:#ff9800;
}

/* ===== D-PAD CONTROLS ===== */
.dpad {
  display: grid;
  grid-template-columns: 60px 60px 60px;
  grid-template-rows: 60px 60px 60px;
  gap: 10px;
  justify-content: center;
  align-items: center;
  margin: 20px auto;
}

.arrow-btn {
  width: 60px;
  height: 60px;
  background: #333;
  color: white;
  font-size: 24px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}

.arrow-btn:hover {
  background: #555;
}

.arrow-btn:active {
  transform: scale(0.95);
  background: orange;
}

/* Grid positions */
.up    { grid-column: 2; grid-row: 1; }
.left  { grid-column: 1; grid-row: 2; }
.stop  { grid-column: 2; grid-row: 2; background:#666; }
.right { grid-column: 3; grid-row: 2; }
.down  { grid-column: 2; grid-row: 3; }


/* ===== CARDS ===== */
.cards{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:20px;
}
.card{
  height:140px;
  background:#8feb8e;
  border-radius:25px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:18px;
}
.card strong{
  font-size: 24px;
  font-family: 'Orbitron', sans-serif;
}

/* ===== ZONES ===== */
.zones{
  text-align:center;
  margin-top:30px;
}
.zone{
  display:inline-block;
  padding:10px 30px;
  border-radius:12px;
  background:#ccc;
  margin:5px;
  cursor:pointer;
}
.active-zone{
  background:#ff9800;
}

/* ===== CONTROLS ===== */
.controls{
  text-align:center;
  margin-top:15px;
}
.controls button{
  padding:8px 16px;
  margin:5px;
}

/* ===== EMERGENCY ===== */
.emergency{
  margin-top:15px;
  background:#ff6b6b;
  padding:12px;
  border-radius:20px;
  font-weight:bold;
  cursor:pointer;
}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.7);
  z-index:1000;
}
.modal-box{
  background:#000;
  width:90%;
  height:80%;
  margin:5% auto;
  border-radius:20px;
  padding:20px;
  position:relative;
}
.close{
  position:absolute;
  top:15px;
  right:20px;
  color:#9c27ff;
  cursor:pointer;
  font-weight:bold;
}
.toggle{
  text-align:center;
  margin-bottom:10px;
}
.toggle select{
  padding:5px 10px;
}
</style>

</head>

<body>

<div class="wrapper">

  <div class="health-banner" id="healthMsg">
    Air is safe for indoor activities.
  </div>
  <div class="health-banner" id="roverStatus">
    Rover Status: <strong>IDLE</strong>
  </div>

  <div class="top-row">
    <div class="info-box">Location: <span id="loc">Room1</span></div>
    <div class="info-box">Time: <span id="time">--</span></div>
  </div>

  <div class="content">

    <div class="risk-meter">
      <div class="risk-fill" id="riskFill"></div>
    </div>

    <div class="cards">
      <div class="card" id="aqiCard" onclick="openGraph()">
        <strong>AQI</strong>
        <div id="aqi">--</div>
        <div id="aqiStatus">--</div>
      </div>
      <div class="card"><strong>Temperature</strong><div id="temp">--</div></div>
      <div class="card"><strong>Humidity</strong><div id="hum">--</div></div>
      <div class="card"><strong>PM2.5</strong><div id="pm25">--</div></div>
    </div>

  </div>

  <div class="zones">
    <div class="zone active-zone" onclick="selectRoom('Room1')" id="Room1">Room 1</div>
    <div class="zone" onclick="selectRoom('Room2')" id="Room2">Room 2</div>
  </div>

  <div class="controls">
    <button id="startBtn" onclick="sendCmd('start')">Start Patrol</button>
    <button id="stopBtn" onclick="sendCmd('stop')">Stop Patrol</button>
    <button id="autoBtn" onclick="sendCmd('auto')">Auto Mode</button>
    <button id="manualBtn" onclick="sendCmd('manual')">Manual Mode</button>

  </div>
  <!-- MANUAL ROVER CONTROLS -->
  <div id="manualControls" style="display:none; margin-top:25px;">

    <div class="dpad">
      <button class="arrow-btn up" onclick="move('forward')">‚Üë</button>

      <button class="arrow-btn left" onclick="move('left')">‚Üê</button>
      <button class="arrow-btn stop" onclick="move('stop')">‚ñ†</button>
      <button class="arrow-btn right" onclick="move('right')">‚Üí</button>
   
      <button class="arrow-btn down" onclick="move('backward')">‚Üì</button>
    </div>
 
  </div>



  <div class="controls">
    <div class="emergency" id="emergencyBtn" onclick="toggleEmergency()">
      EMERGENCY !!
    </div>
  </div>

</div>

<!-- GRAPH MODAL -->
<div class="modal" id="graphModal">
  <div class="modal-box">
    <div class="close" onclick="closeGraph()">CLOSE</div>
    <h2 style="color:white;text-align:center;">AQI TREND</h2>

    <div class="toggle">
      <select id="modeSelect" onchange="loadGraph()">
        <option value="hourly">Hourly</option>
        <option value="daily">Daily</option>
      </select>
    </div>

    <canvas id="aqiChart"></canvas>
  </div>
</div>

<script>
let chart=null;
let emergencyTriggered = false;

function getColor(aqi){
  if(aqi<=100) return ["#4caf50","GOOD","Air is safe for indoor activities."];
  if(aqi<=200) return ["#ffeb3b","MODERATE","Sensitive groups should be cautious."];
  if(aqi<=300) return ["#ff9800","POOR","Avoid prolonged exposure."];
  return ["#f44336","VERY POOR"," Health risk!!!"];
}

/* ===== GRAPH ===== */
function openGraph(){
  document.getElementById("graphModal").style.display="block";
  loadGraph();
}
function closeGraph(){
  document.getElementById("graphModal").style.display="none";
}

function loadGraph(){
  const mode=document.getElementById("modeSelect").value;

  fetch(`/history?mode=${mode}`)
    .then(r=>r.json())
    .then(data=>{
      const labels=data.map(d=>mode==="hourly"?d.time:d.date);
      const values=data.map(d=>d.aqi);

      if(chart) chart.destroy();

      chart=new Chart(document.getElementById("aqiChart"),{
        type:"line",
        data:{
          labels:labels,
          datasets:[{
            data:values,
            borderWidth:3,
            tension:0.4,
            segment:{
              borderColor:ctx=>{
                return getColor(ctx.p0.parsed.y)[0];
              }
            }
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{display:false} },
          scales:{
            x:{
              grid:{ color:"rgba(255,255,255,0.15)" },
              border:{ color:"#fff", width:2 },
              ticks:{ color:"#fff" }
            },
            y:{
              grid:{ color:"rgba(255,255,255,0.15)" },
              border:{ color:"#fff", width:2 },
              ticks:{ color:"#fff" },
              min:0,
              max:400
            }
          }
        }
      });
    });
}
function selectRoom(room){
  // Update global room
  currentRoom = room;

  // Update UI
  document.getElementById("loc").innerText = room;

  document.querySelectorAll(".zone").forEach(z=>{
    z.classList.remove("active-zone");
  });
  document.getElementById(room).classList.add("active-zone");

  console.log("üìç ROOM SELECTED:", currentRoom);
}

function updateUI(data){
  const [color,status,msg] = getColor(data.aqi);

  // AQI card
  const card = document.getElementById("aqiCard");
  card.className = "card";
  card.style.background = color;

  if(data.aqi <= 100) card.classList.add("glow-green");
  else if(data.aqi <= 200) card.classList.add("glow-yellow");
  else if(data.aqi <= 300) card.classList.add("glow-orange");
  else card.classList.add("glow-red");

  document.getElementById("aqi").innerText = data.aqi;
  document.getElementById("aqiStatus").innerText = status;

  // Health banner
  document.getElementById("healthMsg").innerText = msg;

  // Risk meter
  const risk = document.getElementById("riskFill");
  risk.style.height = Math.min((data.aqi / 400) * 100, 100) + "%";
  risk.style.background = color;

  // Other values
  document.getElementById("temp").innerText = data.temperature + "¬∞C";
  document.getElementById("hum").innerText = data.humidity + "%";
  document.getElementById("pm25").innerText = data.pm25;
  document.getElementById("time").innerText = data.time;
  // ===== BACKGROUND COLOR SYNC =====
  document.body.style.background = color + "55"; 
  
  document.querySelector(".health-banner").style.background =
    `linear-gradient(135deg, ${color}, #00000020)`;

  document.querySelector(".health-banner").style.boxShadow =
    `0 0 35px ${color}`;

  document.querySelector(".wrapper").style.background =
    `linear-gradient(180deg, ${color}22, #f7f7f7)`;
  // ===== EXTREME DANGER PULSE (AQI > 600 ONLY) =====
  const healthBanner = document.querySelector(".health-banner");
  const wrapper = document.querySelector(".wrapper");

  if (data.aqi > 600) {
    healthBanner.classList.add("danger-pulse");
    wrapper.classList.add("danger-pulse");
  } else {
    healthBanner.classList.remove("danger-pulse");
    wrapper.classList.remove("danger-pulse");
  }
  // üî¥ AUTO-EMERGENCY TRIGGER
  if (data.aqi > 750 && !emergencyTriggered) {
    console.warn("üö® AQI CRITICAL! AUTO EMERGENCY TRIGGERED");

    emergencyTriggered = true; // lock

    // Call backend emergency (SMS already handled there)
    fetch("/emergency", { method: "POST" });

    // UI effects
    const em = document.querySelector(".emergency");
    if (em) em.classList.add("emergency-active");

    // Sound alert
    
    const audio = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
    audio.play();

    alert("üö® CRITICAL AQI (>750)\nEmergency mode activated automatically!");
  }
  // üü¢ AUTO RESET (optional)
  if (data.aqi < 300 && emergencyTriggered) {
    emergencyTriggered = false;

    fetch("/emergency/clear", { method: "POST" });

    const em = document.querySelector(".emergency");
    if (em) em.classList.remove("emergency-active");

    console.log("‚úÖ AQI normalized, emergency cleared");
  }
  if(data.movement){
    updateMovementUI(data.movement);
  }

}
function sendCmd(cmd){
  console.log("ROVER COMMAND:", cmd);

  // Send command to backend
  fetch("/control", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ command: cmd })
  });

  // üîÑ Remove glow from all mode buttons
  ["startBtn","stopBtn","autoBtn","manualBtn"].forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.classList.remove("mode-active");
  });

  // ‚ú® Glow selected button
  const activeBtn = document.getElementById(cmd + "Btn");
  if(activeBtn) activeBtn.classList.add("mode-active");

  // Update status + arrow visibility
  updateRoverStatus(cmd);
}
function move(direction, btn){
  // Remove highlight from all arrow buttons
  document.querySelectorAll(".arrow-btn")
    .forEach(b => b.classList.remove("active"));

  // Highlight current button
  if(btn) btn.classList.add("active");

  console.log("ROVER MOVE:", direction);

  fetch("/control", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ command: direction })
  });
}
function emergency(){
  console.log("EMERGENCY TRIGGERED");

  fetch("/emergency", { method: "POST" })
    .then(res => res.json())
    .then(data => {
      console.log("Emergency response:", data);
    });

  // UI effect
  const em = document.querySelector(".emergency");
  em.classList.add("emergency-active");

  // Sound alert
  const audio = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
  audio.play();

  alert("‚ö†Ô∏è EMERGENCY MODE ACTIVATED");
}
let emergencyActive = false;
let emergencyAudio = null;

function toggleEmergency(){
  if(!emergencyActive){
    activateEmergency();
  }else{
    deactivateEmergency();
  }
}

function activateEmergency(){
  emergencyActive = true;
  console.log("EMERGENCY ACTIVATED");

  fetch("/emergency", { method: "POST" });

  const btn = document.getElementById("emergencyBtn");
  btn.classList.add("emergency-active");
  btn.innerText = "CLEAR EMERGENCY";

  emergencyAudio = new Audio(
    "https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"
  );
  emergencyAudio.loop = true;
  emergencyAudio.play();

  document.getElementById("healthMsg").innerText =
    "‚ö†Ô∏è EMERGENCY MODE ACTIVE ‚Äì TAKE IMMEDIATE ACTION";
}

function deactivateEmergency(){
  emergencyActive = false;
  console.log("EMERGENCY CLEARED");

  fetch("/emergency/clear", { method: "POST" });

  const btn = document.getElementById("emergencyBtn");
  btn.classList.remove("emergency-active");
  btn.innerText = "EMERGENCY !!";

  if(emergencyAudio){
    emergencyAudio.pause();
    emergencyAudio.currentTime = 0;
  }

  document.getElementById("healthMsg").innerText =
    "Emergency cleared. System back to normal monitoring.";
}

// make sure currentRoom is the same variable you use in your UI (Room1/Room2)
let currentRoom = "Room1"; // keep this in sync with your room selector

// send reading to server and include room
function sendReadingToServer(reading){
  // üî• AUTO attach selected room
  reading.room = currentRoom;

  console.log("üì° SENDING DATA:", reading);

  fetch("/update", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(reading)
  })
  .then(res => {
    if (!res.ok) throw new Error("Server error");
    return res.json();
  })

  .then(resp => {
    console.log("‚úÖ STORED IN", currentRoom);
  })
  .catch(err => {
    console.error("‚ùå STORE FAILED", err);
  });
}

function updateMovementUI(movement){
  document.querySelectorAll(".arrow-btn")
    .forEach(b => b.classList.remove("active"));

  const btn = document.getElementById(`btn-${movement}`);
  if(btn) btn.classList.add("active");
}
function updateRoverStatus(mode){
  const statusBox = document.getElementById("roverStatus");
  const manualControls = document.getElementById("manualControls");

  if (!statusBox) return;

  // Reset
  statusBox.className = "health-banner";
  manualControls.style.display = "none";

  if(mode === "start"){
    statusBox.classList.add("status-start");
    statusBox.innerHTML = "Rover Status: <strong>PATROL RUNNING</strong>";
  }
  else if(mode === "stop"){
    statusBox.classList.add("status-stop");
    statusBox.innerHTML = "Rover Status: <strong>STOPPED</strong>";
  }
  else if(mode === "auto"){
    statusBox.classList.add("status-auto");
    statusBox.innerHTML = "Rover Status: <strong>AUTO MODE</strong>";
  }
  else if(mode === "manual"){
    statusBox.classList.add("status-manual");
    statusBox.innerHTML = "Rover Status: <strong>MANUAL MODE</strong>";

    // ‚úÖ SHOW arrows ONLY in manual mode
    manualControls.style.display = "block";
  }
}

document.addEventListener("DOMContentLoaded", () => {

  // ---------- MANUAL MODE BUTTON ----------
  const manualBtn = document.getElementById("manualBtn");
  const manualControls = document.getElementById("manualControls");

  if (manualBtn && manualControls) {
    manualBtn.addEventListener("click", () => {
      manualControls.style.display = "block";
    });
  }

  // ---------- JOYSTICK SAFE BINDING ----------
  const joystick = document.getElementById("joystick");
  const stick = document.getElementById("stick");

  if (joystick && stick) {
    let dragging = false;

    joystick.addEventListener("mousedown", () => dragging = true);
    joystick.addEventListener("touchstart", () => dragging = true);

    document.addEventListener("mouseup", () => dragging = false);
    document.addEventListener("touchend", () => dragging = false);

    document.addEventListener("mousemove", handleMove);
    document.addEventListener("touchmove", handleMove);

    function handleMove(e){
      if(!dragging) return;

      const rect = joystick.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left - rect.width/2;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top - rect.height/2;

      // Optional: direction feedback
      if(Math.abs(x) > Math.abs(y)){
        sendMovement(x > 0 ? "right" : "left");
      } else {
        sendMovement(y > 0 ? "backward" : "forward");
      }
    }
  }

});

/* ================= LIVE DATA FETCH ================= */

function fetchLiveData() {
  fetch(`/latest?room=${currentRoom}`)
    .then(res => res.json())
    .then(data => {
      if (!data || data.aqi === undefined) {
        return; // no data yet for this room
      }

      console.log("LIVE DATA:", data);
      updateUI(data);
    })
    .catch(err => console.error("Live fetch error:", err));
}

/* poll every 3 seconds */
setInterval(fetchLiveData, 3000);

/* fetch immediately on page load */
fetchLiveData();

</script>

</body>
</html>
